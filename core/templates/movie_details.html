{% extends 'base.html' %}

{% block title %}
    Movie Details
{% endblock %}

{% block body %}
<div class="container-fluid" style="background: linear-gradient(rgba(0,0,0,0.6), rgba(0,0,0,0.6)), url('https://image.tmdb.org/t/p/original{{ movie.backdrop_path }}') center/cover no-repeat; min-height: 400px;">
  <div class="container">
    <div class="row">
      <div class="col-4">
        {% if movie.poster_path %}
          <img src="https://image.tmdb.org/t/p/w200{{ movie.poster_path }}" alt="{{ movie.title }} poster" style="min-height: 400px;">
        {% endif %}
      </div>
      <div class="col-7">
        <h1 class="mt-4 mb-0">{{ movie.title }}</h1>
        <h6 class="fw-semibold">{{ movie.release_date }}</h6 class="fw-semibold">
        <div class="mb-2">
          {% for genre in movie.genres %}
            <span class="badge bg-info text-dark me-1">{{ genre.name }}</span>
          {% endfor %}
        </div>
        <div class="mb-2 d-flex">
          {% set rating = (movie.vote_average / 2) %}
          {% for i in range(1, 6) %}
            {% if rating >= i %}
              <i class="bi bi-star-fill text-warning"></i>
            {% elif rating >= i - 0.5 %}
              <i class="bi bi-star-half text-warning"></i>
            {% else %}
              <i class="bi bi-star text-warning"></i>
            {% endif %}
          {% endfor %}
          <p class="text-light ms-1">({{ "%.1f"|format(rating) }})</p>
        </div>
        <h5 class="mb-1">Overview</h5>
        <p>{{ movie.overview }}</p>
      </div>
    </div>
  </div>
</div>

<div class="container mt-2 mb-4">
  <a class="btn btn-link px-0 py-2" href="{{ url_for('web.home') }}">
    <i class="bi bi-arrow-left me-1"></i> Back to Popular Movies
  </a>
  <div class="mb-2 d-flex justify-content-between align-items-center">
    <h1>Reviews</h1>
    {% if user.is_authenticated %}
      <button type="button"
        class="btn btn-primary"
        data-bs-toggle="modal"
        data-bs-target="#reviewModal"
        id="createReviewButton">
        <i class="bi bi-plus-lg me-1"></i>
        Write a Review
      </button>
    {% endif %}
  </div>

  {% if reviews %}
    {% for review in reviews %}
      <div class="d-flex align-items-center">
        <i class="bi bi-person-circle fs-2 me-2"></i>
        <h6 class="m-0 p-0">{{ review.user.username }}</h6>
        <span class="mx-2 text-muted">|</span>
        <div class="me-2 d-flex">
          {% for i in range(1, 6) %}
            {% if review.rating >= i %}
              <i class="bi bi-star-fill text-warning"></i>
            {% elif review.rating >= i - 0.5 %}
              <i class="bi bi-star-half text-warning"></i>
            {% else %}
              <i class="bi bi-star text-warning"></i>
            {% endif %}
          {% endfor %}
        </div>
        {% if user.is_authenticated and user.id == review.user_id %}
          <span class="me-2 text-muted">|</span>
          <button class="btn btn-outline-primary btn-sm me-1 editReviewButton"
            data-bs-toggle="modal"
            data-bs-target="#reviewModal"
            data-review-id="{{ review.id }}"
            data-review-label="{{ review.label }}"
            data-review-rating="{{ review.rating }}"
            data-review-body="{{ review.body }}">
            <i class="bi bi-pencil-square"></i>
          </button>
          <form action="{{
            url_for(
              'web.manage_review',
              review_id=review.id
            )
            }}"
            method="POST"
            class="d-inline">
            <input type="hidden" name="action" value="delete" />
            <button class="btn btn-outline-danger btn-sm"
              type="submit"
              onclick="return confirm('Are you sure you want to delete this review?')">
              <i class="bi bi-trash-fill"></i>
            </button>
          </form>
        {% endif %}
      </div>
      <h6 class="mb-0">{{ review.label }}</h6>
      <p class="mb-0">{{ review.body }}</p>
      <hr class="my-2" />
    {% endfor %}
  {% else %}
    <div class="alert alert-warning">There are currently no reviews for this movie.</div>
  {% endif %}
</div>
  

  <!-- Review Modal (for both creating and editing) -->
  <div class="modal fade"
    id="reviewModal"
    tabindex="-1"
    aria-labelledby="reviewModalLabel"
    aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <!-- Form action will be set dynamically via JS -->
        <form id="reviewForm" method="POST">
          <div class="modal-header">
            <h4 class="modal-title" id="reviewModalLabel">Write a Review</h4>
            <button type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close">
            </button>
          </div>
          <div class="modal-body py-2">
            <input type="hidden" name="review_id" id="review_id" value="" />
            <input type="hidden" name="movie_id" id="movie_id" value="{{ movie.id }}" />
            <input type="hidden"
              name="action"
              id="formAction"
              value="create" />
            <div class="mb-2">
              <label for="label" class="form-label">Title</label>
              <input type="text"
                class="form-control"
                id="label"
                name="label"
                placeholder="Enter a title..."
                required />
            </div>
            <div class="mb-2">
              <label class="form-label mb-0">Rating</label>
              <div id="starRating" class="d-flex">
                {% for i in range(1, 6) %}
                  <i class="bi bi-star fs-3 text-warning star"
                    data-value="{{ i }}"
                    style="cursor: pointer;"></i>
                {% endfor %}
              </div>
              <input type="hidden" id="rating" name="rating" required>
            </div>
            <div class="mb-2">
              <label for="body" class="form-label">Review</label>
              <textarea class="form-control"
                id="body"
                name="body"
                rows="4"
                placeholder="Enter a review..."></textarea>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal">
              Cancel
            </button>
            <button type="submit" class="btn btn-primary" id="submitButton">
              Add Review
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
{% endblock %}

{% block scripts %} 
 <script>
   document.addEventListener("DOMContentLoaded", () => {
     // Cache DOM elements for better readability and performance
     const reviewForm = document.getElementById("reviewForm");
     const modalLabel = document.getElementById("reviewModalLabel");
     const submitButton = document.getElementById("submitButton");
     const reviewIdField = document.getElementById("review_id");
     const formActionField = document.getElementById("formAction");
     const labelInput = document.getElementById("label");
     const ratingInput = document.getElementById("rating");
     const bodyInput = document.getElementById("body");
     const createReviewBtn = document.getElementById("createReviewButton");
     const stars = document.querySelectorAll("#starRating .star");
     const reviewModal = document.getElementById('reviewModal');

     // URL templates (dummy id of 0 is used for edit URL; we'll replace it later)
     const manageReviewUrlTemplate =
       "{{ url_for('web.manage_review', review_id=0) }}";
     const createReviewUrl = "{{ url_for('web.create_review') }}";

     // Helper: Build the URL for editing a review
     const buildEditUrl = (reviewId) => {
       // Using string slicing to remove the dummy review id and append the real one
       const baseUrl = manageReviewUrlTemplate.substring(
         0,
         manageReviewUrlTemplate.lastIndexOf("/") + 1
       );
       return baseUrl + reviewId;
     };

     // Set up the modal for creating a new review
     const setupCreateModal = () => {
       modalLabel.textContent = "Write a Review";
       submitButton.textContent = "Add Review";
       reviewForm.action = createReviewUrl;
       reviewIdField.value = "";
       formActionField.value = "create";
       labelInput.value = "";
       ratingInput.value = "1";
       bodyInput.value = "";

       stars.forEach(s => {
        if (s.getAttribute("data-value") <= 1) {
          s.classList.remove("bi-star");
          s.classList.add("bi-star-fill");
        } else {
          s.classList.remove("bi-star-fill");
          s.classList.add("bi-star");
        }
      });
     };

     // Set up the modal for editing an existing review
     const setupEditModal = (reviewData) => {
       modalLabel.textContent = "Edit Review";
       submitButton.textContent = "Save Changes";
       reviewForm.action = buildEditUrl(reviewData.reviewId);
       reviewIdField.value = reviewData.reviewId;
       formActionField.value = "update";
       labelInput.value = reviewData.label;
       ratingInput.value = reviewData.rating;
       bodyInput.value = reviewData.body;
     };

     // When the Create Note button is clicked, configure modal for creation
     createReviewBtn.addEventListener("click", setupCreateModal);

     // Attach event listeners to all Edit buttons using clear helper logic
     document.querySelectorAll(".editReviewButton").forEach((button) => {
       button.addEventListener("click", () => {
         const reviewData = {
           reviewId: button.getAttribute("data-review-id"),
           label: button.getAttribute("data-review-label"),
           rating: button.getAttribute("data-review-rating"),
           body: button.getAttribute("data-review-body"),
         };
         setupEditModal(reviewData);
       });
     });

      // Star click events — update rating value and star display
      stars.forEach(star => {
        star.addEventListener("click", () => {
          const rating = star.getAttribute("data-value");
          ratingInput.value = rating;

          // Update star appearance based on selected rating
          stars.forEach(s => {
            if (s.getAttribute("data-value") <= rating) {
              s.classList.remove("bi-star");
              s.classList.add("bi-star-fill");
            } else {
              s.classList.remove("bi-star-fill");
              s.classList.add("bi-star");
            }
          });
        });
      });

      // When modal opens, pre-fill rating stars based on existing value
      reviewModal.addEventListener('show.bs.modal', event => {
        const button = event.relatedTarget;

        // If this is an edit button
        if (button) {
          const existingRating = button.getAttribute('data-review-rating');

          // Update the hidden input
          ratingInput.value = existingRating || "";

          // Update stars to match existing rating
          stars.forEach(s => {
            if (s.getAttribute("data-value") <= existingRating) {
              s.classList.remove("bi-star");
              s.classList.add("bi-star-fill");
            } else {
              s.classList.remove("bi-star-fill");
              s.classList.add("bi-star");
            }
          });
        } else {
          // If no button (new review), reset everything
          ratingInput.value = "";
          stars.forEach(s => {
            s.classList.remove("bi-star-fill");
            s.classList.add("bi-star");
          });
        }
      });
   });
 </script>
{% endblock %}